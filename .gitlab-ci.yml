stages:
  - log-commits
  - build-graalvm
  - micronaut
  - test


#  _                                                 _ _
# | | ___   __ _        ___ ___  _ __ ___  _ __ ___ (_) |_ ___
# | |/ _ \ / _` |_____ / __/ _ \| '_ ` _ \| '_ ` _ \| | __/ __|
# | | (_) | (_| |_____| (_| (_) | | | | | | | | | | | | |_\__ \
# |_|\___/ \__, |      \___\___/|_| |_| |_|_| |_| |_|_|\__|___/
#          |___/
log-commits:
  image: alpine:3.8
  stage: log-commits
  script:
    - ./log-commits.sh


#  _           _ _     _                             _
# | |__  _   _(_) | __| |       __ _ _ __ __ _  __ _| |
# | '_ \| | | | | |/ _` |_____ / _` | '__/ _` |/ _` | |
# | |_) | |_| | | | (_| |_____| (_| | | | (_| | (_| | |
# |_.__/ \__,_|_|_|\__,_|      \__, |_|  \__,_|\__,_|_|
#                              |___/
.build-graalvm:template: &build-graalvm-template
  stage: build-graalvm
  dependencies:
    - log-commits
  needs: ["log-commits"]
  artifacts:
    expire_in: 5 days
    paths:
      - $CI_PROJECT_DIR/graal_dist
  cache:
    key: ${GRAAL_NEW_COMMIT}-${CI_JOB_NAME}
    paths:
      - $CI_PROJECT_DIR/graal_dist
  tags:
    - aws
    - speed2x
    - memory2x

jdk11:build-graalvm:
  <<: *build-graalvm-template
  script:
    - if [ -d $CI_PROJECT_DIR/graal_dist ]; then exit 0; fi
    - ./build-graalvm.sh jdk11

jdk17:build-graalvm:
  <<: *build-graalvm-template
  script:
    - if [ -d $CI_PROJECT_DIR/graal_dist ]; then exit 0; fi
    - ./build-graalvm.sh jdk17


#            _                                  _
#  _ __ ___ (_) ___ _ __ ___  _ __   __ _ _   _| |_
# | '_ ` _ \| |/ __| '__/ _ \| '_ \ / _` | | | | __|
# | | | | | | | (__| | | (_) | | | | (_| | |_| | |_
# |_| |_| |_|_|\___|_|  \___/|_| |_|\__,_|\__,_|\__|
#
.micronaut:build-template: &micronaut-build-template
  stage: micronaut
  image: registry.gitlab.com/micronaut-projects/micronaut-graal-tests/graalvm-builder
  before_script:
    - export APP_BRANCH=$(echo $CI_BUILD_REF_NAME | sed "s/-dev//" | sed "s/-stable//" | sed "s/-prerelease//")
  artifacts:
    expire_in: 5 days
  allow_failure: true
  retry:
    max: 2
    when:
      - always

.jdk11:micronaut-build: &jdk11-build
  <<: *micronaut-build-template
  dependencies:
    - jdk11:build-graalvm
  needs: ["jdk11:build-graalvm"]

.jdk17:micronaut-build: &jdk17-build
  <<: *micronaut-build-template
  dependencies:
    - jdk17:build-graalvm
  needs: ["jdk17:build-graalvm"]

jdk11:basic-app:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-basic-app/basic-app
  script:
    - ./build-basic-app.sh
  tags:
    - aws
    - speed

jdk17:basic-app:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-basic-app/basic-app
  script:
    - ./build-basic-app.sh
  tags:
    - aws
    - speed

jdk11:email:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-email/native-email
  script:
    - ./build-email.sh
  tags:
    - aws
    - speed
    
jdk17:email:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-email/native-email
  script:
    - ./build-email.sh
  tags:
    - aws
    - speed

jdk11:kotlin:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-kotlin-graal/kotlin
  script:
    - ./build-kotlin.sh
  tags:
    - aws
    - memory

jdk17:kotlin:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-kotlin-graal/kotlin
  script:
    - ./build-kotlin.sh
  tags:
    - aws
    - memory

jdk11:maven:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-maven-graal/maven
  script:
    - ./build-maven.sh
  tags:
    - aws
    - speed

jdk17:maven:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-maven-graal/maven
  script:
    - ./build-maven.sh
  tags:
    - aws
    - speed

jdk11:service-discovery-consul:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-service-discovery-consul/service-discovery-consul
  script:
    - ./build-service-discovery-consul.sh
  tags:
    - aws
    - speed

jdk17:service-discovery-consul:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-service-discovery-consul/service-discovery-consul
  script:
    - ./build-service-discovery-consul.sh
  tags:
    - aws
    - speed

.jdk11:service-discovery-eureka:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-service-discovery-eureka/service-discovery-eureka
  script:
    - ./build-service-discovery-eureka.sh
  tags:
    - aws
    - speed

.jdk17:service-discovery-eureka:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-service-discovery-eureka/service-discovery-eureka
  script:
    - ./build-service-discovery-eureka.sh
  tags:
    - aws
    - speed

jdk11:zipkin:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-zipkin-graal/zipkin
  script:
    - ./build-zipkin.sh
  tags:
    - aws
    - speed

jdk17:zipkin:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-zipkin-graal/zipkin
  script:
    - ./build-zipkin.sh
  tags:
    - aws
    - speed

jdk11:rabbitmq:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-rabbitmq-graal/rabbitmq
  script:
    - ./build-rabbitmq.sh
  tags:
    - aws
    - speed

jdk17:rabbitmq:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-rabbitmq-graal/rabbitmq
  script:
    - ./build-rabbitmq.sh
  tags:
    - aws
    - speed

jdk11:management:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-management-graal/management
  script:
    - ./build-management.sh
  tags:
    - aws
    - speed

jdk17:management:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-management-graal/management
  script:
    - ./build-management.sh
  tags:
    - aws
    - speed

jdk11:views-freemarker:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-views-graal/views-freemarker
  script:
    - ./build-views.sh freemarker
  tags:
    - aws
    - speed

jdk17:views-freemarker:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-views-graal/views-freemarker
  script:
    - ./build-views.sh freemarker
  tags:
    - aws
    - speed

.jdk11:views-handlebars:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-views-graal/views-handlebars
  script:
    - ./build-views.sh handlebars
  tags:
    - aws
    - speed

.jdk17:views-handlebars:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-views-graal/views-handlebars
  script:
    - ./build-views.sh handlebars
  tags:
    - aws
    - speed

jdk11:views-thymeleaf:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-views-graal/views-thymeleaf
  script:
    - ./build-views.sh thymeleaf
  tags:
    - aws
    - speed

jdk17:views-thymeleaf:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-views-graal/views-thymeleaf
  script:
    - ./build-views.sh thymeleaf
  tags:
    - aws
    - speed

jdk11:views-velocity:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-views-graal/views-velocity
  script:
    - ./build-views.sh velocity
  tags:
    - aws
    - speed

jdk17:views-velocity:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-views-graal/views-velocity
  script:
    - ./build-views.sh velocity
  tags:
    - aws
    - speed

jdk11:views-pebble:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-views-graal/views-pebble
  script:
    - ./build-views.sh pebble
  tags:
    - aws
    - speed

jdk17:views-pebble:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-views-graal/views-pebble
  script:
    - ./build-views.sh pebble
  tags:
    - aws
    - speed

jdk11:security-jwt:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-security-jwt-graal/security-jwt
  script:
    - ./build-security-jwt.sh
  tags:
    - aws
    - speed

jdk17:security-jwt:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-security-jwt-graal/security-jwt
  script:
    - ./build-security-jwt.sh
  tags:
    - aws
    - speed

jdk11:security-basic-auth:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-security-basic-auth-graal/security-basic-auth
  script:
    - ./build-security-basic-auth.sh
  tags:
    - aws
    - speed

jdk17:security-basic-auth:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-security-basic-auth-graal/security-basic-auth
  script:
    - ./build-security-basic-auth.sh
  tags:
    - aws
    - speed

jdk11:security-cookie:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-security-cookie-graal/security-cookie
  script:
    - ./build-security-cookie.sh
  tags:
    - aws
    - speed

jdk17:security-cookie:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-security-cookie-graal/security-cookie
  script:
    - ./build-security-cookie.sh
  tags:
    - aws
    - speed

jdk11:security-session:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-security-session-graal/security-session
  script:
    - ./build-security-session.sh
  tags:
    - aws
    - speed

jdk17:security-session:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-security-session-graal/security-session
  script:
    - ./build-security-session.sh
  tags:
    - aws
    - speed

jdk11:security-ldap:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-security-ldap-graal/security-ldap
  script:
    - ./build-security-ldap.sh
  tags:
    - aws
    - speed

jdk17:security-ldap:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-security-ldap-graal/security-ldap
  script:
    - ./build-security-ldap.sh
  tags:
    - aws
    - speed

jdk11:data-jdbc-h2:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jdbc-graal/data-jdbc-h2
  script:
    - ./build-data-jdbc.sh h2
  tags:
    - aws
    - speed

jdk17:data-jdbc-h2:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jdbc-graal/data-jdbc-h2
  script:
    - ./build-data-jdbc.sh h2
  tags:
    - aws
    - speed

jdk11:data-jdbc-postgres:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jdbc-graal/data-jdbc-postgres
  script:
    - ./build-data-jdbc.sh postgres
  tags:
    - aws
    - speed

jdk17:data-jdbc-postgres:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jdbc-graal/data-jdbc-postgres
  script:
    - ./build-data-jdbc.sh postgres
  tags:
    - aws
    - speed

jdk11:data-jdbc-oracle:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jdbc-graal/data-jdbc-oracle
  script:
    - ./build-data-jdbc.sh oracle
  tags:
    - aws
    - memory

jdk17:data-jdbc-oracle:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jdbc-graal/data-jdbc-oracle
  script:
    - ./build-data-jdbc.sh oracle
  tags:
    - aws
    - memory

jdk11:data-jdbc-mariadb:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jdbc-graal/data-jdbc-mariadb
  script:
    - ./build-data-jdbc.sh mariadb
  tags:
    - aws
    - memory

jdk17:data-jdbc-mariadb:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jdbc-graal/data-jdbc-mariadb
  script:
    - ./build-data-jdbc.sh mariadb
  tags:
    - aws
    - memory

jdk11:data-jdbc-sqlserver:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jdbc-graal/data-jdbc-sqlserver
  script:
    - ./build-data-jdbc.sh sqlserver
  tags:
    - aws
    - speed

jdk17:data-jdbc-sqlserver:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jdbc-graal/data-jdbc-sqlserver
  script:
    - ./build-data-jdbc.sh sqlserver
  tags:
    - aws
    - speed

jdk11:data-jdbc-mysql:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jdbc-graal/data-jdbc-mysql
  script:
    - ./build-data-jdbc.sh mysql
  tags:
    - aws
    - memory

jdk17:data-jdbc-mysql:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jdbc-graal/data-jdbc-mysql
  script:
    - ./build-data-jdbc.sh mysql
  tags:
    - aws
    - speed

jdk11:data-jpa-h2:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jpa-graal/data-jpa-h2
  script:
    - ./build-data-jpa.sh h2
  tags:
    - aws
    - memory

jdk17:data-jpa-h2:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jpa-graal/data-jpa-h2
  script:
    - ./build-data-jpa.sh h2
  tags:
    - aws
    - memory

jdk11:data-jpa-postgres:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jpa-graal/data-jpa-postgres
  script:
    - ./build-data-jpa.sh postgres
  tags:
    - aws
    - memory

jdk17:data-jpa-postgres:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jpa-graal/data-jpa-postgres
  script:
    - ./build-data-jpa.sh postgres
  tags:
    - aws
    - memory

jdk11:data-jpa-mariadb:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jpa-graal/data-jpa-mariadb
  script:
    - ./build-data-jpa.sh mariadb
  tags:
    - aws
    - memory

jdk17:data-jpa-mariadb:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jpa-graal/data-jpa-mariadb
  script:
    - ./build-data-jpa.sh mariadb
  tags:
    - aws
    - memory

jdk11:data-jpa-mysql:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jpa-graal/data-jpa-mysql
  script:
    - ./build-data-jpa.sh mysql
  tags:
    - aws
    - memory

jdk17:data-jpa-mysql:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jpa-graal/data-jpa-mysql
  script:
    - ./build-data-jpa.sh mysql
  tags:
    - aws
    - memory

jdk11:data-jpa-oracle:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jpa-graal/data-jpa-oracle
  script:
    - ./build-data-jpa.sh oracle
  tags:
    - aws
    - memory

jdk17:data-jpa-oracle:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jpa-graal/data-jpa-oracle
  script:
    - ./build-data-jpa.sh oracle
  tags:
    - aws
    - memory

jdk11:data-jpa-sqlserver:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jpa-graal/data-jpa-sqlserver
  script:
    - ./build-data-jpa.sh sqlserver
  tags:
    - aws
    - memory

jdk17:data-jpa-sqlserver:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-data-jpa-graal/data-jpa-sqlserver
  script:
    - ./build-data-jpa.sh sqlserver
  tags:
    - aws
    - memory

jdk11:schedule:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-schedule-graal/schedule
  script:
    - ./build-schedule.sh
  tags:
    - aws
    - speed

jdk17:schedule:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-schedule-graal/schedule
  script:
    - ./build-schedule.sh
  tags:
    - aws
    - speed

jdk11:cache:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-cache-graal/cache
  script:
    - ./build-cache.sh
  tags:
    - aws
    - speed

jdk17:cache:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-cache-graal/cache
  script:
    - ./build-cache.sh
  tags:
    - aws
    - speed

jdk11:servlet-tomcat:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-servlet-graal/servlet-tomcat
  script:
    - ./build-servlet.sh tomcat
  tags:
    - aws
    - speed

jdk17:servlet-tomcat:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-servlet-graal/servlet-tomcat
  script:
    - ./build-servlet.sh tomcat
  tags:
    - aws
    - speed

jdk11:servlet-jetty:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-servlet-graal/servlet-jetty
  script:
    - ./build-servlet.sh jetty
  tags:
    - aws
    - speed

jdk17:servlet-jetty:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-servlet-graal/servlet-jetty
  script:
    - ./build-servlet.sh jetty
  tags:
    - aws
    - speed

jdk11:introspected:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-introspected-graal/introspected
  script:
    - ./build-introspected.sh
  tags:
    - aws
    - speed

jdk17:introspected:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-introspected-graal/introspected
  script:
    - ./build-introspected.sh
  tags:
    - aws
    - speed

jdk11:flyway-h2:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-flyway-graal/flyway-h2
  script:
    - ./build-flyway.sh h2
  tags:
    - aws
    - speed

jdk17:flyway-h2:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-flyway-graal/flyway-h2
  script:
    - ./build-flyway.sh h2
  tags:
    - aws
    - speed

jdk11:flyway-postgres:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-flyway-graal/flyway-postgres
  script:
    - ./build-flyway.sh postgres
  tags:
    - aws
    - memory

jdk17:flyway-postgres:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-flyway-graal/flyway-postgres
  script:
    - ./build-flyway.sh postgres
  tags:
    - aws
    - memory

.jdk11:flyway-mariadb:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-flyway-graal/flyway-mariadb
  script:
    - ./build-flyway.sh mariadb
  tags:
    - aws
    - speed

.jdk17:flyway-mariadb:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-flyway-graal/flyway-mariadb
  script:
    - ./build-flyway.sh mariadb
  tags:
    - aws
    - speed

jdk11:elasticsearch:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-elasticsearch-graal/elasticsearch
  script:
    - ./build-elasticsearch.sh
  tags:
    - aws
    - speed

jdk17:elasticsearch:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-elasticsearch-graal/elasticsearch
  script:
    - ./build-elasticsearch.sh
  tags:
    - aws
    - speed

jdk11:jooq-h2:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-jooq-graal/jooq-h2
  script:
    - ./build-jooq-h2.sh
  tags:
    - aws
    - memory

jdk17:jooq-h2:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-jooq-graal/jooq-h2
  script:
    - ./build-jooq-h2.sh
  tags:
    - aws
    - memory

jdk11:jooq-postgres:micronaut-build:
  <<: *jdk11-build
  services:
    - name: postgres:11.5-alpine
      alias: postgreshost
  variables:
    POSTGRES_USER: devDb
    POSTGRES_PASSWORD: devDb
    POSTGRES_DB: devDb
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-jooq-graal/jooq-postgres
  script:
    - ./build-jooq-postgres.sh
  tags:
    - aws
    - memory

jdk17:jooq-postgres:micronaut-build:
  <<: *jdk17-build
  services:
    - name: postgres:11.5-alpine
      alias: postgreshost
  variables:
    POSTGRES_USER: devDb
    POSTGRES_PASSWORD: devDb
    POSTGRES_DB: devDb
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-jooq-graal/jooq-postgres
  script:
    - ./build-jooq-postgres.sh
  tags:
    - aws
    - memory

jdk11:redis:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-redis-graal/redis
  script:
    - ./build-redis.sh
  tags:
    - aws
    - speed

jdk17:redis:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-redis-graal/redis
  script:
    - ./build-redis.sh
  tags:
    - aws
    - speed

jdk11:function-aws:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-function-aws-graal/build/function.zip
      - $CI_PROJECT_DIR/micronaut-function-aws-graal/sam-native.yaml
  script:
    - ./build-function-aws.sh
  tags:
    - aws
    - speed

jdk17:function-aws:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-function-aws-graal/build/function.zip
      - $CI_PROJECT_DIR/micronaut-function-aws-graal/sam-native.yaml
  script:
    - ./build-function-aws.sh
  tags:
    - aws
    - speed

jdk11:aws-app:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-aws-app-graal/build/function.zip
      - $CI_PROJECT_DIR/micronaut-aws-app-graal/sam-native.yaml
  script:
    - ./build-aws-app.sh
  tags:
    - aws
    - speed

jdk17:aws-app:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-aws-app-graal/build/function.zip
      - $CI_PROJECT_DIR/micronaut-aws-app-graal/sam-native.yaml
  script:
    - ./build-aws-app.sh
  tags:
    - aws
    - speed

jdk11:grpc:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-grpc-graal/grpc-server
      - $CI_PROJECT_DIR/micronaut-grpc-graal/grpc-client
  script:
    - ./build-grpc.sh
  tags:
    - aws
    - speed

jdk17:grpc:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-grpc-graal/grpc-server
      - $CI_PROJECT_DIR/micronaut-grpc-graal/grpc-client
  script:
    - ./build-grpc.sh
  tags:
    - aws
    - speed

jdk11:mqtt-v3:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-mqtt-graal/mqtt-v3
  script:
    - ./build-mqtt.sh v3
  tags:
    - aws
    - speed

jdk17:mqtt-v3:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-mqtt-graal/mqtt-v3
  script:
    - ./build-mqtt.sh v3
  tags:
    - aws
    - speed

jdk11:mqtt-v5:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-mqtt-graal/mqtt-v5
  script:
    - ./build-mqtt.sh v5
  tags:
    - aws
    - speed

jdk17:mqtt-v5:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-mqtt-graal/mqtt-v5
  script:
    - ./build-mqtt.sh v5
  tags:
    - aws
    - speed

jdk11:liquibase-h2:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-liquibase-graal/liquibase-h2
  script:
    - ./build-liquibase.sh h2
  tags:
    - aws
    - memory

jdk17:liquibase-h2:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-liquibase-graal/liquibase-h2
  script:
    - ./build-liquibase.sh h2
  tags:
    - aws
    - memory

jdk11:liquibase-postgres:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-liquibase-graal/liquibase-postgres
  script:
    - ./build-liquibase.sh postgres
  tags:
    - aws
    - memory

jdk17:liquibase-postgres:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-liquibase-graal/liquibase-postgres
  script:
    - ./build-liquibase.sh postgres
  tags:
    - aws
    - memory

jdk11:liquibase-mariadb:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-liquibase-graal/liquibase-mariadb
  script:
    - ./build-liquibase.sh mariadb
  tags:
    - aws
    - memory

jdk17:liquibase-mariadb:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-liquibase-graal/liquibase-mariadb
  script:
    - ./build-liquibase.sh mariadb
  tags:
    - aws
    - memory

jdk11:aws-sdkv2-s3:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-aws-sdk2-graal/aws-s3
  script:
    - ./build-aws-sdkv2.sh s3
  tags:
    - aws
    - speed

jdk17:aws-sdkv2-s3:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-aws-sdk2-graal/aws-s3
  script:
    - ./build-aws-sdkv2.sh s3
  tags:
    - aws
    - speed

jdk11:aws-sdkv2-paramstore:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-aws-sdk2-graal/aws-paramstore
  script:
    - ./build-aws-sdkv2.sh paramstore
  tags:
    - aws
    - speed

jdk17:aws-sdkv2-paramstore:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-aws-sdk2-graal/aws-paramstore
  script:
    - ./build-aws-sdkv2.sh paramstore
  tags:
    - aws
    - speed

jdk11:cassandra:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-cassandra-graal/cassandra
  script:
    - ./build-cassandra.sh
  tags:
    - aws
    - speed

jdk17:cassandra:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-cassandra-graal/cassandra
  script:
    - ./build-cassandra.sh
  tags:
    - aws
    - speed

jdk11:kafka:micronaut-build:
  <<: *jdk11-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-kafka-graal/kafka
  script:
    - ./build-kafka.sh
  tags:
    - aws
    - speed

jdk17:kafka:micronaut-build:
  <<: *jdk17-build
  artifacts:
    paths:
      - $CI_PROJECT_DIR/micronaut-kafka-graal/kafka
  script:
    - ./build-kafka.sh
  tags:
    - aws
    - speed


#  _            _
# | |_ ___  ___| |_
# | __/ _ \/ __| __|
# | ||  __/\__ \ |_
#  \__\___||___/\__|
#
.micronaut:test-template: &micronaut-test-template
  stage: test
  image: frolvlad/alpine-glibc:alpine-3.12
  before_script:
    - ./test-before-script.sh
  timeout: 20m
  retry:
    max: 1

.micronaut:test-distroless-template: &micronaut-test-distroless-template
  <<: *micronaut-test-template
  image:
    name: gcr.io/distroless/cc-debian10:debug
    entrypoint: [ "" ]
  before_script:
    - ./test-before-script-distroless.sh

jdk11:basic-app:test:
  <<: *micronaut-test-distroless-template
  dependencies:
    - jdk11:basic-app:micronaut-build
  needs: ["jdk11:basic-app:micronaut-build"]
  script:
    - ./test-basic-app.sh

jdk17:basic-app:test:
  <<: *micronaut-test-distroless-template
  dependencies:
    - jdk17:basic-app:micronaut-build
  needs: ["jdk17:basic-app:micronaut-build"]
  script:
    - ./test-basic-app.sh

jdk11:email:test:
  <<: *micronaut-test-distroless-template
  dependencies:
    - jdk11:email:micronaut-build
  needs: ["jdk11:email:micronaut-build"]
  script:
    - ./test-email.sh

jdk17:email:test:
  <<: *micronaut-test-distroless-template
  dependencies:
    - jdk17:email:micronaut-build
  needs: ["jdk17:email:micronaut-build"]
  script:
    - ./test-email.sh

jdk11:kotlin:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:kotlin:micronaut-build
  needs: ["jdk11:kotlin:micronaut-build"]
  script:
    - ./test-kotlin.sh

jdk17:kotlin:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:kotlin:micronaut-build
  needs: ["jdk17:kotlin:micronaut-build"]
  script:
    - ./test-kotlin.sh

jdk11:maven:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:maven:micronaut-build
  needs: ["jdk11:maven:micronaut-build"]
  script:
    - ./test-maven.sh

jdk17:maven:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:maven:micronaut-build
  needs: ["jdk17:maven:micronaut-build"]
  script:
    - ./test-maven.sh

jdk11:service-discovery-consul:test:
  <<: *micronaut-test-template
  services:
    - name: consul:1.8.0
      alias: consulhost
  dependencies:
    - jdk11:service-discovery-consul:micronaut-build
  needs: ["jdk11:service-discovery-consul:micronaut-build"]
  script:
    - ./test-service-discovery-consul.sh
  tags:
    - aws
    - speed

jdk17:service-discovery-consul:test:
  <<: *micronaut-test-template
  services:
    - name: consul:1.8.0
      alias: consulhost
  dependencies:
    - jdk17:service-discovery-consul:micronaut-build
  needs: ["jdk17:service-discovery-consul:micronaut-build"]
  script:
    - ./test-service-discovery-consul.sh
  tags:
    - aws
    - speed

.jdk11:service-discovery-eureka:test:
  <<: *micronaut-test-template
  services:
    - name: registry.gitlab.com/micronaut-projects/micronaut-graal-tests/eureka-server:2.3.0
      alias: eurekahost
  dependencies:
    - jdk11:service-discovery-eureka:micronaut-build
  needs: ["jdk11:service-discovery-eureka:micronaut-build"]
  script:
    - ./test-service-discovery-eureka.sh
  tags:
    - aws
    - speed

.jdk17:service-discovery-eureka:test:
  <<: *micronaut-test-template
  services:
    - name: registry.gitlab.com/micronaut-projects/micronaut-graal-tests/eureka-server:2.3.0
      alias: eurekahost
  dependencies:
    - jdk17:service-discovery-eureka:micronaut-build
  needs: ["jdk17:service-discovery-eureka:micronaut-build"]
  script:
    - ./test-service-discovery-eureka.sh
  tags:
    - aws
    - speed

jdk11:zipkin:test:
  <<: *micronaut-test-template
  services:
    - name: openzipkin/zipkin:2.21.1
      alias: openzipkin
  dependencies:
    - jdk11:zipkin:micronaut-build
  needs: ["jdk11:zipkin:micronaut-build"]
  script:
    - ./test-zipkin.sh

jdk17:zipkin:test:
  <<: *micronaut-test-template
  services:
    - name: openzipkin/zipkin:2.21.1
      alias: openzipkin
  dependencies:
    - jdk17:zipkin:micronaut-build
  needs: ["jdk17:zipkin:micronaut-build"]
  script:
    - ./test-zipkin.sh

jdk11:rabbitmq:test:
  <<: *micronaut-test-template
  services:
    - name: rabbitmq:3.8.9-management-alpine
      alias: rabbitmqhost
  dependencies:
    - jdk11:rabbitmq:micronaut-build
  needs: ["jdk11:rabbitmq:micronaut-build"]
  script:
    - ./test-rabbitmq.sh

jdk17:rabbitmq:test:
  <<: *micronaut-test-template
  services:
    - name: rabbitmq:3.8.9-management-alpine
      alias: rabbitmqhost
  dependencies:
    - jdk17:rabbitmq:micronaut-build
  needs: ["jdk17:rabbitmq:micronaut-build"]
  script:
    - ./test-rabbitmq.sh

jdk11:management:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:management:micronaut-build
  needs: ["jdk11:management:micronaut-build"]
  script:
    - ./test-management.sh

jdk17:management:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:management:micronaut-build
  needs: ["jdk17:management:micronaut-build"]
  script:
    - ./test-management.sh

jdk11:views-freemarker:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:views-freemarker:micronaut-build
  needs: ["jdk11:views-freemarker:micronaut-build"]
  script:
    - ./test-views-freemarker.sh

jdk17:views-freemarker:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:views-freemarker:micronaut-build
  needs: ["jdk17:views-freemarker:micronaut-build"]
  script:
    - ./test-views-freemarker.sh

.jdk11:views-handlebars:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:views-handlebars:micronaut-build
  needs: ["jdk11:views-handlebars:micronaut-build"]
  script:
    - ./test-views-handlebars.sh

.jdk17:views-handlebars:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:views-handlebars:micronaut-build
  needs: ["jdk17:views-handlebars:micronaut-build"]
  script:
    - ./test-views-handlebars.sh

jdk11:views-thymeleaf:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:views-thymeleaf:micronaut-build
  needs: ["jdk11:views-thymeleaf:micronaut-build"]
  script:
    - ./test-views-thymeleaf.sh

jdk17:views-thymeleaf:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:views-thymeleaf:micronaut-build
  needs: ["jdk17:views-thymeleaf:micronaut-build"]
  script:
    - ./test-views-thymeleaf.sh

jdk11:views-velocity:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:views-velocity:micronaut-build
  needs: ["jdk11:views-velocity:micronaut-build"]
  script:
    - ./test-views-velocity.sh

jdk17:views-velocity:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:views-velocity:micronaut-build
  needs: ["jdk17:views-velocity:micronaut-build"]
  script:
    - ./test-views-velocity.sh

jdk11:views-pebble:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:views-pebble:micronaut-build
  needs: ["jdk11:views-pebble:micronaut-build"]
  script:
    - ./test-views-pebble.sh

jdk17:views-pebble:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:views-pebble:micronaut-build
  needs: ["jdk17:views-pebble:micronaut-build"]
  script:
    - ./test-views-pebble.sh

jdk11:security-jwt:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:security-jwt:micronaut-build
  needs: ["jdk11:security-jwt:micronaut-build"]
  script:
    - ./test-security-jwt.sh

jdk17:security-jwt:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:security-jwt:micronaut-build
  needs: ["jdk17:security-jwt:micronaut-build"]
  script:
    - ./test-security-jwt.sh

jdk11:security-basic-auth:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:security-basic-auth:micronaut-build
  needs: ["jdk11:security-basic-auth:micronaut-build"]
  script:
    - ./test-security-basic-auth.sh

jdk17:security-basic-auth:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:security-basic-auth:micronaut-build
  needs: ["jdk17:security-basic-auth:micronaut-build"]
  script:
    - ./test-security-basic-auth.sh

jdk11:security-cookie:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:security-cookie:micronaut-build
  needs: ["jdk11:security-cookie:micronaut-build"]
  script:
    - ./test-security-cookie.sh

jdk17:security-cookie:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:security-cookie:micronaut-build
  needs: ["jdk17:security-cookie:micronaut-build"]
  script:
    - ./test-security-cookie.sh

jdk11:security-session:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:security-session:micronaut-build
  needs: ["jdk11:security-session:micronaut-build"]
  script:
    - ./test-security-session.sh

jdk17:security-session:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:security-session:micronaut-build
  needs: ["jdk17:security-session:micronaut-build"]
  script:
    - ./test-security-session.sh

jdk11:security-ldap:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:security-ldap:micronaut-build
  needs: ["jdk11:security-ldap:micronaut-build"]
  script:
    - ./test-security-ldap.sh

jdk17:security-ldap:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:security-ldap:micronaut-build
  needs: ["jdk17:security-ldap:micronaut-build"]
  script:
    - ./test-security-ldap.sh

jdk11:data-jdbc-h2:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:data-jdbc-h2:micronaut-build
  needs: ["jdk11:data-jdbc-h2:micronaut-build"]
  script:
    - ./test-data-jdbc-h2.sh

jdk17:data-jdbc-h2:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:data-jdbc-h2:micronaut-build
  needs: ["jdk17:data-jdbc-h2:micronaut-build"]
  script:
    - ./test-data-jdbc-h2.sh

jdk11:data-jdbc-postgres:test:
  <<: *micronaut-test-template
  services:
    - name: postgres:11.5-alpine
      alias: postgreshost
  dependencies:
    - jdk11:data-jdbc-postgres:micronaut-build
  needs: ["jdk11:data-jdbc-postgres:micronaut-build"]
  variables:
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: secret
    POSTGRES_DB: pets
  script:
    - ./test-data-jdbc-postgres.sh

jdk17:data-jdbc-postgres:test:
  <<: *micronaut-test-template
  services:
    - name: postgres:11.5-alpine
      alias: postgreshost
  dependencies:
    - jdk17:data-jdbc-postgres:micronaut-build
  needs: ["jdk17:data-jdbc-postgres:micronaut-build"]
  variables:
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: secret
    POSTGRES_DB: pets
  script:
    - ./test-data-jdbc-postgres.sh

jdk11:data-jdbc-oracle:test:
  <<: *micronaut-test-template
  retry:
    max: 2
    when:
      - always
  services:
    - name: gvenzl/oracle-xe:18.4.0
      alias: oraclehost
  dependencies:
    - jdk11:data-jdbc-oracle:micronaut-build
  needs: ["jdk11:data-jdbc-oracle:micronaut-build"]
  variables:
    ORACLE_PASSWORD: oracle
  script:
    - ./test-data-jdbc-oracle.sh

jdk17:data-jdbc-oracle:test:
  <<: *micronaut-test-template
  retry:
    max: 2
    when:
      - always
  services:
    - name: gvenzl/oracle-xe:18.4.0
      alias: oraclehost
  dependencies:
    - jdk17:data-jdbc-oracle:micronaut-build
  needs: ["jdk17:data-jdbc-oracle:micronaut-build"]
  variables:
    ORACLE_PASSWORD: oracle
  script:
    - ./test-data-jdbc-oracle.sh

jdk11:data-jdbc-mariadb:test:
  <<: *micronaut-test-template
  services:
    - name: mariadb:10.4.8-bionic
      alias: mariadbhost
  dependencies:
    - jdk11:data-jdbc-mariadb:micronaut-build
  needs: ["jdk11:data-jdbc-mariadb:micronaut-build"]
  variables:
    MYSQL_ROOT_PASSWORD: secret
    MYSQL_DATABASE: pets
  script:
    - ./test-data-jdbc-mariadb.sh

jdk17:data-jdbc-mariadb:test:
  <<: *micronaut-test-template
  services:
    - name: mariadb:10.4.8-bionic
      alias: mariadbhost
  dependencies:
    - jdk17:data-jdbc-mariadb:micronaut-build
  needs: ["jdk17:data-jdbc-mariadb:micronaut-build"]
  variables:
    MYSQL_ROOT_PASSWORD: secret
    MYSQL_DATABASE: pets
  script:
    - ./test-data-jdbc-mariadb.sh

jdk11:data-jdbc-sqlserver:test:
  <<: *micronaut-test-template
  services:
    - name: mcr.microsoft.com/mssql/server:2017-latest-ubuntu
      alias: sqlserverhost
  dependencies:
    - jdk11:data-jdbc-sqlserver:micronaut-build
  needs: ["jdk11:data-jdbc-sqlserver:micronaut-build"]
  variables:
    ACCEPT_EULA: Y
    SA_PASSWORD: My!Secret123
    MSSQL_PID: Express
  script:
    - ./test-data-jdbc-sqlserver.sh

jdk17:data-jdbc-sqlserver:test:
  <<: *micronaut-test-template
  services:
    - name: mcr.microsoft.com/mssql/server:2017-latest-ubuntu
      alias: sqlserverhost
  dependencies:
    - jdk17:data-jdbc-sqlserver:micronaut-build
  needs: ["jdk17:data-jdbc-sqlserver:micronaut-build"]
  variables:
    ACCEPT_EULA: Y
    SA_PASSWORD: My!Secret123
    MSSQL_PID: Express
  script:
    - ./test-data-jdbc-sqlserver.sh

jdk11:data-jdbc-mysql:test:
  <<: *micronaut-test-template
  services:
    - name: mysql:8.0.20
      alias: mysqlhost
  dependencies:
    - jdk11:data-jdbc-mysql:micronaut-build
  needs: ["jdk11:data-jdbc-mysql:micronaut-build"]
  variables:
    MYSQL_ROOT_PASSWORD: secret
    MYSQL_DATABASE: pets
  script:
    - ./test-data-jdbc-mysql.sh

jdk17:data-jdbc-mysql:test:
  <<: *micronaut-test-template
  services:
    - name: mysql:8.0.20
      alias: mysqlhost
  dependencies:
    - jdk17:data-jdbc-mysql:micronaut-build
  needs: ["jdk17:data-jdbc-mysql:micronaut-build"]
  variables:
    MYSQL_ROOT_PASSWORD: secret
    MYSQL_DATABASE: pets
  script:
    - ./test-data-jdbc-mysql.sh

jdk11:data-jpa-h2:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:data-jpa-h2:micronaut-build
  needs: ["jdk11:data-jpa-h2:micronaut-build"]
  script:
    - ./test-data-jpa-h2.sh

jdk17:data-jpa-h2:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:data-jpa-h2:micronaut-build
  needs: ["jdk17:data-jpa-h2:micronaut-build"]
  script:
    - ./test-data-jpa-h2.sh

jdk11:data-jpa-postgres:test:
  <<: *micronaut-test-template
  services:
    - name: postgres:11.5-alpine
      alias: postgreshost
  dependencies:
    - jdk11:data-jpa-postgres:micronaut-build
  needs: ["jdk11:data-jpa-postgres:micronaut-build"]
  variables:
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: secret
    POSTGRES_DB: pets
  script:
    - ./test-data-jpa-postgres.sh

jdk17:data-jpa-postgres:test:
  <<: *micronaut-test-template
  services:
    - name: postgres:11.5-alpine
      alias: postgreshost
  dependencies:
    - jdk17:data-jpa-postgres:micronaut-build
  needs: ["jdk17:data-jpa-postgres:micronaut-build"]
  variables:
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: secret
    POSTGRES_DB: pets
  script:
    - ./test-data-jpa-postgres.sh

jdk11:data-jpa-mariadb:test:
  <<: *micronaut-test-template
  services:
    - name: mariadb:10.4.8-bionic
      alias: mariadbhost
  dependencies:
    - jdk11:data-jpa-mariadb:micronaut-build
  needs: ["jdk11:data-jpa-mariadb:micronaut-build"]
  variables:
    MYSQL_ROOT_PASSWORD: secret
    MYSQL_DATABASE: pets
  script:
    - ./test-data-jpa-mariadb.sh

jdk17:data-jpa-mariadb:test:
  <<: *micronaut-test-template
  services:
    - name: mariadb:10.4.8-bionic
      alias: mariadbhost
  dependencies:
    - jdk17:data-jpa-mariadb:micronaut-build
  needs: ["jdk17:data-jpa-mariadb:micronaut-build"]
  variables:
    MYSQL_ROOT_PASSWORD: secret
    MYSQL_DATABASE: pets
  script:
    - ./test-data-jpa-mariadb.sh

jdk11:data-jpa-mysql:test:
  <<: *micronaut-test-template
  services:
    - name: mysql:8.0.20
      alias: mysqlhost
  dependencies:
    - jdk11:data-jpa-mysql:micronaut-build
  needs: ["jdk11:data-jpa-mysql:micronaut-build"]
  variables:
    MYSQL_ROOT_PASSWORD: secret
    MYSQL_DATABASE: pets
  script:
    - ./test-data-jpa-mysql.sh

jdk17:data-jpa-mysql:test:
  <<: *micronaut-test-template
  services:
    - name: mysql:8.0.20
      alias: mysqlhost
  dependencies:
    - jdk17:data-jpa-mysql:micronaut-build
  needs: ["jdk17:data-jpa-mysql:micronaut-build"]
  variables:
    MYSQL_ROOT_PASSWORD: secret
    MYSQL_DATABASE: pets
  script:
    - ./test-data-jpa-mysql.sh

jdk11:data-jpa-oracle:test:
  <<: *micronaut-test-template
  retry:
    max: 2
    when:
      - always
  services:
    - name: gvenzl/oracle-xe:18.4.0
      alias: oraclehost
  dependencies:
    - jdk11:data-jpa-oracle:micronaut-build
  needs: ["jdk11:data-jpa-oracle:micronaut-build"]
  variables:
    ORACLE_PASSWORD: oracle
  script:
    - ./test-data-jpa-oracle.sh

jdk17:data-jpa-oracle:test:
  <<: *micronaut-test-template
  retry:
    max: 2
    when:
      - always
  services:
    - name: gvenzl/oracle-xe:18.4.0
      alias: oraclehost
  dependencies:
    - jdk17:data-jpa-oracle:micronaut-build
  needs: ["jdk17:data-jpa-oracle:micronaut-build"]
  variables:
    ORACLE_PASSWORD: oracle
  script:
    - ./test-data-jpa-oracle.sh

jdk11:data-jpa-sqlserver:test:
  <<: *micronaut-test-template
  services:
    - name: mcr.microsoft.com/mssql/server:2017-latest-ubuntu
      alias: sqlserverhost
  dependencies:
    - jdk11:data-jpa-sqlserver:micronaut-build
  needs: ["jdk11:data-jpa-sqlserver:micronaut-build"]
  variables:
    ACCEPT_EULA: Y
    SA_PASSWORD: My!Secret123
    MSSQL_PID: Express
  script:
    - ./test-data-jpa-sqlserver.sh

jdk17:data-jpa-sqlserver:test:
  <<: *micronaut-test-template
  services:
    - name: mcr.microsoft.com/mssql/server:2017-latest-ubuntu
      alias: sqlserverhost
  dependencies:
    - jdk17:data-jpa-sqlserver:micronaut-build
  needs: ["jdk17:data-jpa-sqlserver:micronaut-build"]
  variables:
    ACCEPT_EULA: Y
    SA_PASSWORD: My!Secret123
    MSSQL_PID: Express
  script:
    - ./test-data-jpa-sqlserver.sh

jdk11:schedule:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:schedule:micronaut-build
  needs: ["jdk11:schedule:micronaut-build"]
  script:
    - ./test-schedule.sh

jdk17:schedule:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:schedule:micronaut-build
  needs: ["jdk17:schedule:micronaut-build"]
  script:
    - ./test-schedule.sh
  tags:
    - aws
    - speed

jdk11:cache:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:cache:micronaut-build
  needs: ["jdk11:cache:micronaut-build"]
  script:
    - ./test-cache.sh

jdk17:cache:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:cache:micronaut-build
  needs: ["jdk17:cache:micronaut-build"]
  script:
    - ./test-cache.sh

jdk11:servlet-tomcat:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:servlet-tomcat:micronaut-build
  needs: ["jdk11:servlet-tomcat:micronaut-build"]
  script:
    - ./test-servlet-tomcat.sh

jdk17:servlet-tomcat:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:servlet-tomcat:micronaut-build
  needs: ["jdk17:servlet-tomcat:micronaut-build"]
  script:
    - ./test-servlet-tomcat.sh

jdk11:servlet-jetty:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:servlet-jetty:micronaut-build
  needs: ["jdk11:servlet-jetty:micronaut-build"]
  script:
    - ./test-servlet-jetty.sh

jdk17:servlet-jetty:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:servlet-jetty:micronaut-build
  needs: ["jdk17:servlet-jetty:micronaut-build"]
  script:
    - ./test-servlet-jetty.sh

jdk11:introspected:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:introspected:micronaut-build
  needs: ["jdk11:introspected:micronaut-build"]
  script:
    - ./test-introspected.sh

jdk17:introspected:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:introspected:micronaut-build
  needs: ["jdk17:introspected:micronaut-build"]
  script:
    - ./test-introspected.sh

jdk11:flyway-h2:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:flyway-h2:micronaut-build
  needs: ["jdk11:flyway-h2:micronaut-build"]
  script:
    - ./test-flyway-h2.sh

jdk17:flyway-h2:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:flyway-h2:micronaut-build
  needs: ["jdk17:flyway-h2:micronaut-build"]
  script:
    - ./test-flyway-h2.sh

jdk11:flyway-postgres:test:
  <<: *micronaut-test-template
  services:
    - name: postgres:11.5-alpine
      alias: postgreshost
  dependencies:
    - jdk11:flyway-postgres:micronaut-build
  needs: ["jdk11:flyway-postgres:micronaut-build"]
  variables:
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: secret
    POSTGRES_DB: users
  script:
    - ./test-flyway-postgres.sh

jdk17:flyway-postgres:test:
  <<: *micronaut-test-template
  services:
    - name: postgres:11.5-alpine
      alias: postgreshost
  dependencies:
    - jdk17:flyway-postgres:micronaut-build
  needs: ["jdk17:flyway-postgres:micronaut-build"]
  variables:
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: secret
    POSTGRES_DB: users
  script:
    - ./test-flyway-postgres.sh

.jdk11:flyway-mariadb:test:
  <<: *micronaut-test-template
  services:
    - name: mariadb:10.4.8-bionic
      alias: mariadbhost
  dependencies:
    - jdk11:flyway-mariadb:micronaut-build
  needs: ["jdk11:flyway-mariadb:micronaut-build"]
  variables:
    MYSQL_ROOT_PASSWORD: secret
    MYSQL_DATABASE: users
  script:
    - ./test-flyway-mariadb.sh

.jdk17:flyway-mariadb:test:
  <<: *micronaut-test-template
  services:
    - name: mariadb:10.4.8-bionic
      alias: mariadbhost
  dependencies:
    - jdk17:flyway-mariadb:micronaut-build
  needs: ["jdk17:flyway-mariadb:micronaut-build"]
  variables:
    MYSQL_ROOT_PASSWORD: secret
    MYSQL_DATABASE: users
  script:
    - ./test-flyway-mariadb.sh

jdk11:elasticsearch:test:
  <<: *micronaut-test-template
  services:
    - name: docker.elastic.co/elasticsearch/elasticsearch:7.15.2
      alias: elasticsearchhost
      command: [ "/bin/elasticsearch", "-Ediscovery.type=single-node" ]
  dependencies:
    - jdk11:elasticsearch:micronaut-build
  needs: ["jdk11:elasticsearch:micronaut-build"]
  script:
    - ./test-elasticsearch.sh

jdk17:elasticsearch:test:
  <<: *micronaut-test-template
  services:
    - name: docker.elastic.co/elasticsearch/elasticsearch:7.15.2
      alias: elasticsearchhost
      command: [ "/bin/elasticsearch", "-Ediscovery.type=single-node" ]
  dependencies:
    - jdk17:elasticsearch:micronaut-build
  needs: ["jdk17:elasticsearch:micronaut-build"]
  script:
    - ./test-elasticsearch.sh

jdk11:jooq-h2:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:jooq-h2:micronaut-build
  needs: ["jdk11:jooq-h2:micronaut-build"]
  script:
    - ./test-jooq-h2.sh

jdk17:jooq-h2:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:jooq-h2:micronaut-build
  needs: ["jdk17:jooq-h2:micronaut-build"]
  script:
    - ./test-jooq-h2.sh

jdk11:jooq-postgres:test:
  <<: *micronaut-test-template
  services:
    - name: postgres:11.5-alpine
      alias: postgreshost
  variables:
    POSTGRES_USER: devDb
    POSTGRES_PASSWORD: devDb
    POSTGRES_DB: devDb
  dependencies:
    - jdk11:jooq-postgres:micronaut-build
  needs: ["jdk11:jooq-postgres:micronaut-build"]
  script:
    - ./test-jooq-postgres.sh

jdk17:jooq-postgres:test:
  <<: *micronaut-test-template
  services:
    - name: postgres:11.5-alpine
      alias: postgreshost
  variables:
    POSTGRES_USER: devDb
    POSTGRES_PASSWORD: devDb
    POSTGRES_DB: devDb
  dependencies:
    - jdk17:jooq-postgres:micronaut-build
  needs: ["jdk17:jooq-postgres:micronaut-build"]
  script:
    - ./test-jooq-postgres.sh

jdk11:redis:test:
  <<: *micronaut-test-template
  services:
    - name: redislabs/redisearch:1.6.13
      alias: redishost
  dependencies:
    - jdk11:redis:micronaut-build
  needs: ["jdk11:redis:micronaut-build"]
  script:
    - ./test-redis.sh

jdk17:redis:test:
  <<: *micronaut-test-template
  services:
    - name: redislabs/redisearch:1.6.13
      alias: redishost
  dependencies:
    - jdk17:redis:micronaut-build
  needs: ["jdk17:redis:micronaut-build"]
  script:
    - ./test-redis.sh

jdk11:function-aws:test:
  <<: *micronaut-test-template
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base
  before_script:
    - echo "" # just to override and skip parent before_script
  dependencies:
    - jdk11:function-aws:micronaut-build
  needs: ["jdk11:function-aws:micronaut-build"]
  script:
    - ./test-function-aws.sh

jdk17:function-aws:test:
  <<: *micronaut-test-template
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base
  before_script:
    - echo "" # just to override and skip parent before_script
  dependencies:
    - jdk17:function-aws:micronaut-build
  needs: ["jdk17:function-aws:micronaut-build"]
  script:
    - ./test-function-aws.sh

jdk11:aws-app:test:
  <<: *micronaut-test-template
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base
  before_script:
    - echo "" # just to override and skip parent before_script
  dependencies:
    - jdk11:aws-app:micronaut-build
  needs: ["jdk11:aws-app:micronaut-build"]
  script:
    - ./test-aws-app.sh

jdk17:aws-app:test:
  <<: *micronaut-test-template
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base
  before_script:
    - echo "" # just to override and skip parent before_script
  dependencies:
    - jdk17:aws-app:micronaut-build
  needs: ["jdk17:aws-app:micronaut-build"]
  script:
    - ./test-aws-app.sh

jdk11:grpc:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:grpc:micronaut-build
  needs: ["jdk11:grpc:micronaut-build"]
  script:
    - ./test-grpc.sh

jdk17:grpc:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:grpc:micronaut-build
  needs: ["jdk17:grpc:micronaut-build"]
  script:
    - ./test-grpc.sh

jdk11:mqtt-v3:test:
  <<: *micronaut-test-template
  services:
    - name: eclipse-mosquitto:1.6.12
      alias: mqtthost
  dependencies:
    - jdk11:mqtt-v3:micronaut-build
  needs: ["jdk11:mqtt-v3:micronaut-build"]
  script:
    - ./test-mqtt-v3.sh

jdk17:mqtt-v3:test:
  <<: *micronaut-test-template
  services:
    - name: eclipse-mosquitto:1.6.12
      alias: mqtthost
  dependencies:
    - jdk17:mqtt-v3:micronaut-build
  needs: ["jdk17:mqtt-v3:micronaut-build"]
  script:
    - ./test-mqtt-v3.sh

jdk11:mqtt-v5:test:
  <<: *micronaut-test-template
  services:
    - name: eclipse-mosquitto:1.6.12
      alias: mqtthost
  dependencies:
    - jdk11:mqtt-v5:micronaut-build
  needs: ["jdk11:mqtt-v5:micronaut-build"]
  script:
    - ./test-mqtt-v5.sh

jdk17:mqtt-v5:test:
  <<: *micronaut-test-template
  services:
    - name: eclipse-mosquitto:1.6.12
      alias: mqtthost
  dependencies:
    - jdk17:mqtt-v5:micronaut-build
  needs: ["jdk17:mqtt-v5:micronaut-build"]
  script:
    - ./test-mqtt-v5.sh

jdk11:liquibase-h2:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:liquibase-h2:micronaut-build
  needs: ["jdk11:liquibase-h2:micronaut-build"]
  script:
    - ./test-liquibase-h2.sh

jdk17:liquibase-h2:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:liquibase-h2:micronaut-build
  needs: ["jdk17:liquibase-h2:micronaut-build"]
  script:
    - ./test-liquibase-h2.sh

jdk11:liquibase-postgres:test:
  <<: *micronaut-test-template
  services:
    - name: postgres:11.5-alpine
      alias: postgreshost
  dependencies:
    - jdk11:liquibase-postgres:micronaut-build
  needs: ["jdk11:liquibase-postgres:micronaut-build"]
  variables:
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: secret
    POSTGRES_DB: users
  script:
    - ./test-liquibase-postgres.sh

jdk17:liquibase-postgres:test:
  <<: *micronaut-test-template
  services:
    - name: postgres:11.5-alpine
      alias: postgreshost
  dependencies:
    - jdk17:liquibase-postgres:micronaut-build
  needs: ["jdk17:liquibase-postgres:micronaut-build"]
  variables:
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: secret
    POSTGRES_DB: users
  script:
    - ./test-liquibase-postgres.sh

jdk11:liquibase-mariadb:test:
  <<: *micronaut-test-template
  services:
    - name: mariadb:10.4.8-bionic
      alias: mariadbhost
  dependencies:
    - jdk11:liquibase-mariadb:micronaut-build
  needs: ["jdk11:liquibase-mariadb:micronaut-build"]
  variables:
    MYSQL_ROOT_PASSWORD: secret
    MYSQL_DATABASE: users
  script:
    - ./test-liquibase-mariadb.sh

jdk17:liquibase-mariadb:test:
  <<: *micronaut-test-template
  services:
    - name: mariadb:10.4.8-bionic
      alias: mariadbhost
  dependencies:
    - jdk17:liquibase-mariadb:micronaut-build
  needs: ["jdk17:liquibase-mariadb:micronaut-build"]
  variables:
    MYSQL_ROOT_PASSWORD: secret
    MYSQL_DATABASE: users
  script:
    - ./test-liquibase-mariadb.sh

jdk11:aws-sdkv2-s3:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:aws-sdkv2-s3:micronaut-build
  needs: ["jdk11:aws-sdkv2-s3:micronaut-build"]
  script:
    - ./test-aws-sdkv2-s3.sh

jdk17:aws-sdkv2-s3:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:aws-sdkv2-s3:micronaut-build
  needs: ["jdk17:aws-sdkv2-s3:micronaut-build"]
  script:
    - ./test-aws-sdkv2-s3.sh

jdk11:aws-sdkv2-paramstore:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk11:aws-sdkv2-paramstore:micronaut-build
  needs: ["jdk11:aws-sdkv2-paramstore:micronaut-build"]
  script:
    - ./test-aws-sdkv2-paramstore.sh

jdk17:aws-sdkv2-paramstore:test:
  <<: *micronaut-test-template
  dependencies:
    - jdk17:aws-sdkv2-paramstore:micronaut-build
  needs: ["jdk17:aws-sdkv2-paramstore:micronaut-build"]
  script:
    - ./test-aws-sdkv2-paramstore.sh

jdk11:cassandra:test:
  <<: *micronaut-test-template
  services:
    - name: cassandra:3.11.10
      alias: cassandrahost
  dependencies:
    - jdk11:cassandra:micronaut-build
  needs: ["jdk11:cassandra:micronaut-build"]
  script:
    - ./test-cassandra.sh

jdk17:cassandra:test:
  <<: *micronaut-test-template
  services:
    - name: cassandra:3.11.10
      alias: cassandrahost
  dependencies:
    - jdk17:cassandra:micronaut-build
  needs: ["jdk17:cassandra:micronaut-build"]
  script:
    - ./test-cassandra.sh

jdk11:kafka:test:
  <<: *micronaut-test-template
  services:
    - name: lensesio/fast-data-dev
      alias: kafkahost
  dependencies:
    - jdk11:kafka:micronaut-build
  needs: ["jdk11:kafka:micronaut-build"]
  script:
    - ./test-kafka.sh

jdk17:kafka:test:
  <<: *micronaut-test-template
  services:
    - name: lensesio/fast-data-dev
      alias: kafkahost
  dependencies:
    - jdk17:kafka:micronaut-build
  needs: ["jdk17:kafka:micronaut-build"]
  script:
    - ./test-kafka.sh